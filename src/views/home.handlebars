<div class="dashboard">
  <h1 class="dashboard-title">Home</h1>

  <div class="product-grid">
    {{#each products}}
      <div class="product-card">
        <div class="product-image-container">
          <img class="product-image" src={{this.thumbnail}} alt="" />
        </div>
        <h2 class="product-title">{{this.title}}</h2>
        <h3 class="product-price">Precio: ${{this.price}}</h3>
        <button onclick="addToCart('{{this._id}}')">
          Añadir al carrito
        </button>
      </div>
    {{/each}}
  </div>

  <div>
    {{#each links}}
      <a href={{this.link}}>{{this.text}}</a>
    {{/each}}
  </div>

  <a href="/addProduct">Añadir Producto</a>
  <a href="/cart">Ver Carrito</a>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
  const socket = io();

  socket.on("productsUpdated", () => {
    location.reload();
  });
</script>

<script>
async function getOrCreateCart() {
  let cid = localStorage.getItem("cart_id");

  if (!cid) {
    const res = await fetch("/api/carts", { method: "POST" });
    const data = await res.json();
    cid = data.payload._id;

    localStorage.setItem("cart_id", cid);
  }

  return cid;
}

getOrCreateCart();
</script>

<script>
  async function addToCart(pid) {
    const cid = await getOrCreateCart();

    const res = await fetch(`/api/carts/${cid}/product/${pid}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quantity: 1 })
    });

    const data = await res.json();
    console.log(data);

    updateCartCounter();
  }
</script>