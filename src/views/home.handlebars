<div class="dashboard">
  <h1 class="dashboard-title">Home</h1>

  <div class="links">
    {{#each links}}
      <a href="{{this.link}}">{{this.text}}</a>
    {{/each}}
  </div>

  <div class="nav">
    <a href="/addProduct">Añadir Producto</a>
    <a href="/cart">
      Ver Carrito (<span id="cart-counter">0</span>)
    </a>
  </div>

  <div class="product-grid">
    {{#each products}}
      <div class="product-card">
        <div class="product-image-container">
          <img class="product-image" src="{{this.thumbnail}}" alt="{{this.title}}" />
        </div>
        <h2 class="product-title">{{this.title}}</h2>
        <h3 class="product-price">Precio: ${{this.price}}</h3>
        <button class="product-add" onclick="addToCart('{{this._id}}')">
          Añadir al carrito
        </button>
      </div>
    {{/each}}
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
async function getOrCreateCart() {
  let cid = localStorage.getItem("cart_id");

  if (!cid) {
    const res = await fetch("/api/carts", { method: "POST" });
    const data = await res.json();
    cid = data.payload._id;
    localStorage.setItem("cart_id", cid);
  }

  return cid;
}

async function updateCartCounter() {
  const counter = document.getElementById("cart-counter");
  if (!counter) return;

  const cid = localStorage.getItem("cart_id");
  if (!cid) {
    counter.textContent = 0;
    return;
  }

  const res = await fetch(`/api/carts/${cid}`);
  const data = await res.json();

  const items = data.payload?.products || data.payload || [];

  const total = items.reduce((acc, item) => acc + item.quantity, 0);
  counter.textContent = total;
}

async function addToCart(pid) {
  const cid = await getOrCreateCart();

  await fetch(`/api/carts/${cid}/product/${pid}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ quantity: 1 })
  });

  updateCartCounter();
}

getOrCreateCart().then(updateCartCounter);
</script>
